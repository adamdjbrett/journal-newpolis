name: Deploy Eleventy to XMIT

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      site:
        description: "XMIT site/domain (e.g. tnpj.xmit.dev)"
        required: true
        type: string

concurrency:
  group: deploy-xmit-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ELEVENTY_RUN_MODE: build
  NODE_OPTIONS: "--max-old-space-size=8192"
  USE_CACHED_THEORY: "1"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      XMIT_SITE: tnpj.xmit.dev@268
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: npm

      - name: Cache Eleventy
        uses: actions/cache@v4
        with:
          path: |
            .cache
            _site
          key: eleventy-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            eleventy-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build site
        run: npx @11ty/eleventy

      - name: Deploy to XMIT
        run: npx xmit@latest deploy _site
        env:
          XMIT_TOKEN: ${{ secrets.XMIT_TOKEN }}

      - name: Summary
        run: echo "âœ… Deployed to ${{ env.XMIT_SITE }}" >> "$GITHUB_STEP_SUMMARY"